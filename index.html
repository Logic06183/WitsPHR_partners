<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wits Planetary Health Research Global Partners</title>
    <link rel="stylesheet" href="static/styles.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Wits Planetary Health Research Global Partners</h1>
        
        <div class="controls">
            <div class="region-tabs">
                <button class="tab-button active" data-region="global">Global View</button>
                <button class="tab-button" data-region="africa">Africa</button>
                <button class="tab-button" data-region="europe">Europe</button>
                <button class="tab-button" data-region="usa">United States</button>
            </div>
            
            <div class="filter-controls">
                <label for="project-filter">Filter:</label>
                <div id="project-filter"></div>
            </div>
        </div>
        
        <div id="map" class="map-container"></div>
        
        <div id="stats" class="stats-panel">
            <h3>Partnership Statistics</h3>
            <div id="stats-content"></div>
        </div>
    </div>

    <script>
        // Partner and funder data
        const data = {
            partners: {
                'Institution': [
                    // CHAMNHA Partners
                    'Aga Khan University', 'Institut de Recherche en Sciences de la SantÃ©',
                    'London School of Hygiene and Tropical Medicine', 'University of Washington',
                    'University of Oslo', 'Karolinska University', 'South African Medical Research Council',
                    
                    // HE2AT Partners
                    'CeSHHAR', 'University of Cape Town', 'University Peleforo Gon Coulibaly',
                    'IBM Research Africa', 'University of Michigan', 'University of Washington',
                    
                    // HIGH Partners
                    'Aga Khan University', 'World Health Organization',
                    'London School of Hygiene and Tropical Medicine', 'Lunds University',
                    'Karolinska University', 'Azienda Sanitaria Locale Roma',
                    'Denmark Technical University', 'University of Graz',
                    
                    // ENBEL Partners
                    'Aga Khan University', 'University of Botswana',
                    'London School of Hygiene and Tropical Medicine', 'Umea University',
                    'University of Graz', 'Azienda Sanitaria Locale Roma',
                    'Tartu Ulikool', 'Folkehelseinstituttet',
                    'Center for International Climate Research', 'Royal College of Surgeons in Ireland',
                    'Health and Environment Alliance', 'International Red Cross Red Crescent Centre',
                    'University Paul Sabatier Toulouse', 'Goeteborgs University',
                    'Ilmatieteen Laitos', 'Lunds University'
                ],
                'City': [
                    // CHAMNHA
                    'Nairobi', 'Ouagadougou', 'London', 'Seattle', 
                    'Oslo', 'Stockholm', 'Cape Town',
                    
                    // HE2AT
                    'Harare', 'Cape Town', 'Korhogo',
                    'Nairobi', 'Ann Arbor', 'Seattle',
                    
                    // HIGH
                    'Nairobi', 'Geneva',
                    'London', 'Lund',
                    'Stockholm', 'Rome',
                    'Copenhagen', 'Graz',
                    
                    // ENBEL
                    'Nairobi', 'Gaborone',
                    'London', 'Umea',
                    'Graz', 'Rome',
                    'Tartu', 'Oslo',
                    'Oslo', 'Dublin',
                    'Brussels', 'The Hague',
                    'Toulouse', 'Gothenburg',
                    'Helsinki', 'Lund'
                ],
                'Projects': [
                    // CHAMNHA (7)
                    ['CHAMNHA'], ['CHAMNHA'], ['CHAMNHA'], ['CHAMNHA'],
                    ['CHAMNHA'], ['CHAMNHA'], ['CHAMNHA'],
                    
                    // HE2AT (6)
                    ['HE2AT'], ['HE2AT'], ['HE2AT'],
                    ['HE2AT'], ['HE2AT'], ['HE2AT'],
                    
                    // HIGH (8)
                    ['HIGH'], ['HIGH'],
                    ['HIGH'], ['HIGH'],
                    ['HIGH'], ['HIGH'],
                    ['HIGH'], ['HIGH'],
                    
                    // ENBEL (16)
                    ['ENBEL'], ['ENBEL'],
                    ['ENBEL'], ['ENBEL'],
                    ['ENBEL'], ['ENBEL'],
                    ['ENBEL'], ['ENBEL'],
                    ['ENBEL'], ['ENBEL'],
                    ['ENBEL'], ['ENBEL'],
                    ['ENBEL'], ['ENBEL'],
                    ['ENBEL'], ['ENBEL']
                ]
            },
            funders: {
                'Institution': [
                    'UK Research and Innovation', 'Clinical Research Network Norway',
                    'Forte', 'National Institutes of Health',
                    'European Union Horizon Programme'
                ],
                'City': [
                    'London', 'Oslo', 'Stockholm', 'Bethesda', 'Brussels'
                ],
                'Projects': [
                    ['CHAMNHA'], ['CHAMNHA'], ['CHAMNHA'], ['CHAMNHA', 'HE2AT'],
                    ['HIGH', 'ENBEL']
                ]
            }
        };

        // Coordinates lookup
        const coordinates = {
            'Nairobi': [-1.2921, 36.8219],
            'Ouagadougou': [12.3714, -1.5197],
            'London': [51.5074, -0.1278],
            'Seattle': [47.6062, -122.3321],
            'Oslo': [59.9139, 10.7522],
            'Stockholm': [59.3293, 18.0686],
            'Cape Town': [-33.9249, 18.4241],
            'Harare': [-17.8252, 31.0335],
            'Korhogo': [9.4557, -5.6290],
            'Ann Arbor': [42.2808, -83.7430],
            'Geneva': [46.2044, 6.1432],
            'Lund': [55.7047, 13.1910],
            'Rome': [41.9028, 12.4964],
            'Copenhagen': [55.6761, 12.5683],
            'Graz': [47.0707, 15.4395],
            'Gaborone': [-24.6282, 25.9231],
            'Umea': [63.8258, 20.2630],
            'Tartu': [58.3780, 26.7290],
            'Dublin': [53.3498, -6.2603],
            'Brussels': [50.8503, 4.3517],
            'The Hague': [52.0705, 4.3007],
            'Toulouse': [43.6047, 1.4442],
            'Gothenburg': [57.7089, 11.9746],
            'Helsinki': [60.1699, 24.9384],
            'Bethesda': [38.9847, -77.0947]
        };

        // Project colors
        const colors = {
            'CHAMNHA': '#1f77b4',  // Blue
            'HE2AT': '#2ca02c',    // Green
            'HIGH': '#ff7f0e',     // Orange
            'ENBEL': '#d62728',    // Red
            'Funder': '#9467bd'    // Purple
        };

        // Region configurations
        const regions = {
            global: {
                center: { lon: 15, lat: 30 },
                zoom: 1.5
            },
            africa: {
                center: { lon: 20, lat: 0 },
                zoom: 2.5,
                lats: [-40, 40],
                lons: [-20, 60]
            },
            europe: {
                center: { lon: 15, lat: 55 },
                zoom: 3,
                lats: [35, 75],
                lons: [-10, 40]
            },
            usa: {
                center: { lon: -98, lat: 40 },
                zoom: 3.5,
                lats: [25, 50],
                lons: [-125, -65]
            }
        };

        // Initialize active region
        let activeRegion = 'global';

        // Add click handlers for region tabs
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                // Update active tab
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                
                // Update map
                activeRegion = e.target.dataset.region;
                updateMap(activeRegion);
            });
        });

        // Create filter checkboxes
        const projectFilter = document.getElementById('project-filter');
        
        // Add layer type filter
        const layerDiv = document.createElement('div');
        layerDiv.className = 'filter-group';
        layerDiv.innerHTML = '<label><b>Layer Type:</b></label>';
        const layerTypes = ['Partners', 'Funders'];
        layerTypes.forEach(type => {
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = type.toLowerCase();
            checkbox.checked = true;
            checkbox.className = 'layer-checkbox';
            checkbox.addEventListener('change', updateMap);
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(` ${type}`));
            layerDiv.appendChild(label);
        });
        projectFilter.appendChild(layerDiv);

        // Add project filter
        const projectDiv = document.createElement('div');
        projectDiv.className = 'filter-group';
        projectDiv.innerHTML = '<label><b>Projects:</b></label>';
        Object.keys(colors).filter(k => k !== 'Funder').forEach(project => {
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = project;
            checkbox.checked = true;
            checkbox.className = 'project-checkbox';
            checkbox.addEventListener('change', updateMap);
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(` ${project}`));
            projectDiv.appendChild(label);
        });
        projectFilter.appendChild(projectDiv);

        function getSelectedFilters() {
            return {
                layers: Array.from(document.querySelectorAll('.layer-checkbox:checked')).map(cb => cb.value),
                projects: Array.from(document.querySelectorAll('.project-checkbox:checked')).map(cb => cb.value)
            };
        }

        function updateMap(region = 'global') {
            const view = regions[region];
            
            // Configure text visibility based on view
            const textposition = region === 'global' ? 'none' : 'top';
            const hoverinfo = region === 'global' ? 'text' : 'text+name';
            
            // Filter data based on region
            const filteredData = filterDataByRegion(data, region);
            
            // Create partner traces
            const partnerTraces = createTraces(
                filteredData.partners,
                'circle',
                'Partners',
                'rgba(44, 62, 80, 0.8)',
                region === 'global' ? 6 : 8,
                textposition,
                hoverinfo
            );

            // Create funder traces with more subtle styling
            const funderTraces = createTraces(
                filteredData.funders,
                'diamond',
                'Funders',
                'rgba(52, 152, 219, 0.8)',
                region === 'global' ? 7 : 9,
                textposition,
                hoverinfo
            );

            const layout = {
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1,
                    bgcolor: 'rgba(255, 255, 255, 0.9)',
                    bordercolor: '#e0e0e0',
                    borderwidth: 1,
                    font: {
                        family: 'Arial, sans-serif',
                        size: 12,
                        color: '#2c3e50'
                    }
                },
                geo: {
                    scope: region === 'usa' ? 'usa' : 'world',
                    projection: {
                        type: region === 'usa' ? 'albers usa' : 'mercator'
                    },
                    showland: true,
                    showocean: true,
                    showlakes: true,
                    showcountries: true,
                    showcoastlines: true,
                    coastlinecolor: 'rgb(200, 200, 200)',
                    oceancolor: 'rgb(240, 245, 255)',
                    landcolor: 'rgb(250, 250, 250)',
                    countrycolor: 'rgb(220, 220, 220)',
                    lonaxis: {
                        gridcolor: 'rgb(240, 240, 240)',
                        gridwidth: 0.5,
                        range: view.lons
                    },
                    lataxis: {
                        gridcolor: 'rgb(240, 240, 240)',
                        gridwidth: 0.5,
                        range: view.lats
                    },
                    center: view.center,
                    zoom: view.zoom
                },
                margin: {
                    l: 0,
                    r: 0,
                    t: 0,
                    b: 0
                },
                hoverlabel: {
                    bgcolor: 'white',
                    font: {
                        family: 'Arial, sans-serif',
                        size: 12,
                        color: '#2c3e50'
                    },
                    bordercolor: '#e0e0e0',
                    align: 'left'
                },
                paper_bgcolor: 'rgb(255, 255, 255)',
                plot_bgcolor: 'rgb(255, 255, 255)',
                font: {
                    family: 'Arial, sans-serif',
                    size: 12,
                    color: '#2c3e50'
                },
                annotations: []  // Clear any existing annotations
            };

            Plotly.newPlot('map', [...partnerTraces, ...funderTraces], layout, { 
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                displaylogo: false
            });
            updateStats([...partnerTraces, ...funderTraces]);
        }

        function filterDataByRegion(data, region) {
            if (region === 'global') return data;

            const view = regions[region];
            const filtered = {
                partners: {
                    Institution: [],
                    City: [],
                    Projects: []
                },
                funders: {
                    Institution: [],
                    City: [],
                    Projects: []
                }
            };

            // Helper function to check if coordinates are in region bounds
            const isInRegion = (city) => {
                const coords = coordinates[city];
                return coords[0] >= view.lats[0] && coords[0] <= view.lats[1] &&
                       coords[1] >= view.lons[0] && coords[1] <= view.lons[1];
            };

            // Filter partners
            data.partners.Institution.forEach((inst, idx) => {
                if (isInRegion(data.partners.City[idx])) {
                    filtered.partners.Institution.push(inst);
                    filtered.partners.City.push(data.partners.City[idx]);
                    filtered.partners.Projects.push(data.partners.Projects[idx]);
                }
            });

            // Filter funders
            data.funders.Institution.forEach((inst, idx) => {
                if (isInRegion(data.funders.City[idx])) {
                    filtered.funders.Institution.push(inst);
                    filtered.funders.City.push(data.funders.City[idx]);
                    filtered.funders.Projects.push(data.funders.Projects[idx]);
                }
            });

            return filtered;
        }

        function createTraces(data, symbol, name, color, size, textposition, hoverinfo) {
            const uniqueProjects = [...new Set(data.Projects.flat())];
            
            return uniqueProjects.map(project => {
                const indices = data.Projects.map((p, i) => p.includes(project) ? i : -1).filter(i => i !== -1);
                
                // Create a simplified institution name for labels
                const getShortName = (name) => {
                    // Remove common words to shorten labels
                    return name.replace(/(University|of|The|Institute|Center|Centre|Research|International)/g, '')
                              .replace(/\s+/g, ' ')
                              .trim();
                };

                const trace = {
                    type: 'scattergeo',
                    lon: indices.map(i => coordinates[data.City[i]][1]),
                    lat: indices.map(i => coordinates[data.City[i]][0]),
                    text: indices.map(i => {
                        const institution = data.Institution[i];
                        const city = data.City[i];
                        const projects = data.Projects[i].join(', ');
                        return `<b>${institution}</b><br>City: ${city}<br>Project: ${projects}`;
                    }),
                    name: `${name} (${project})`,
                    marker: {
                        size: size,
                        symbol: symbol,
                        color: color,
                        line: {
                            width: 1,
                            color: 'white'
                        }
                    },
                    mode: textposition === 'none' ? 'markers' : 'markers+text',
                    textposition: textposition,
                    hoverinfo: hoverinfo,
                    showlegend: true,
                    textfont: {
                        family: 'Arial, sans-serif',
                        size: 10,
                        color: 'rgba(44, 62, 80, 0.75)'
                    }
                };

                if (textposition !== 'none') {
                    // Use shortened names for labels
                    trace.text = indices.map(i => getShortName(data.Institution[i]));
                    
                    // Add text template for better label formatting
                    trace.texttemplate = '%{text}';
                    
                    // Adjust text positioning to reduce overlap
                    trace.textposition = indices.map((_, idx) => {
                        // Alternate between top and bottom positions
                        return idx % 2 === 0 ? 'top center' : 'bottom center';
                    });
                }

                return trace;
            });
        }

        function updateStats(traces) {
            const statsContent = document.getElementById('stats-content');
            const partners = traces.find(t => t.name.startsWith('Partners'));
            const funders = traces.find(t => t.name.startsWith('Funders'));
            
            const stats = {
                partners: partners ? partners.lon.length : 0,
                funders: funders ? funders.lon.length : 0,
                countries: new Set([
                    ...(partners ? partners.text.map(t => t.split('<br>')[1].split(',')[0].trim()) : []),
                    ...(funders ? funders.text.map(t => t.split('<br>')[1].split(',')[0].trim()) : [])
                ]).size,
                projects: new Set([
                    ...(partners ? partners.text.flatMap(t => t.split('Project: ')[1].split(', ')) : []),
                    ...(funders ? funders.text.flatMap(t => t.split('Project: ')[1].split(', ')) : [])
                ]).size
            };
            
            statsContent.innerHTML = `
                <p>Research Partners: ${stats.partners}</p>
                <p>Funding Organizations: ${stats.funders}</p>
                <p>Countries: ${stats.countries}</p>
                <p>Active Projects: ${stats.projects}</p>
            `;
        }

        // Initial map update
        updateMap();
    </script>
</body>
</html>
