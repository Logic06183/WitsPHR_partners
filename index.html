<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wits Planetary Health Research Global Partners</title>
    <link rel="stylesheet" href="static/styles.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Wits Planetary Health Research Global Partners</h1>
        
        <div class="region-tabs">
            <button class="tab-button active" data-region="global">Global View</button>
            <button class="tab-button" data-region="africa">Africa</button>
            <button class="tab-button" data-region="europe">Europe</button>
            <button class="tab-button" data-region="usa">United States</button>
        </div>

        <div class="controls">
            <div class="filter-group">
                <label><strong>Layer Type:</strong></label>
                <label>
                    <input type="checkbox" class="layer-filter" value="partners" checked> Partners
                </label>
                <label>
                    <input type="checkbox" class="layer-filter" value="funders" checked> Funders
                </label>
            </div>

            <div class="filter-group">
                <label><strong>Projects:</strong></label>
                <label>
                    <input type="checkbox" class="project-filter" value="CHAMNHA" checked> CHAMNHA
                </label>
                <label>
                    <input type="checkbox" class="project-filter" value="HE2AT" checked> HE2AT
                </label>
                <label>
                    <input type="checkbox" class="project-filter" value="HIGH" checked> HIGH
                </label>
                <label>
                    <input type="checkbox" class="project-filter" value="ENBEL" checked> ENBEL
                </label>
            </div>
        </div>

        <div id="map" class="map-container"></div>

        <div class="stats-panel">
            <h3>Statistics</h3>
            <p>Partners: <span id="partner-count">0</span></p>
            <p>Funders: <span id="funder-count">0</span></p>
            <p>Countries: <span id="country-count">0</span></p>
            <p>Active Projects: <span id="project-count">0</span></p>
        </div>
    </div>

    <script>
        // Partner and funder data
        const data = {
            partners: {
                'Institution': [
                    // CHAMNHA Partners
                    'Aga Khan University', 'Institut de Recherche en Sciences de la SantÃ©',
                    'London School of Hygiene and Tropical Medicine', 'University of Washington',
                    'University of Oslo', 'Karolinska University', 'South African Medical Research Council',
                    
                    // HE2AT Partners
                    'CeSHHAR', 'University of Cape Town', 'University Peleforo Gon Coulibaly',
                    'IBM Research Africa', 'University of Michigan', 'University of Washington',
                    
                    // HIGH Partners
                    'Aga Khan University', 'World Health Organization',
                    'London School of Hygiene and Tropical Medicine', 'Lunds University',
                    'Karolinska University', 'Azienda Sanitaria Locale Roma',
                    'Denmark Technical University', 'University of Graz',
                    
                    // ENBEL Partners
                    'Aga Khan University', 'University of Botswana',
                    'London School of Hygiene and Tropical Medicine', 'Umea University',
                    'University of Graz', 'Azienda Sanitaria Locale Roma',
                    'Tartu Ulikool', 'Folkehelseinstituttet',
                    'Center for International Climate Research', 'Royal College of Surgeons in Ireland',
                    'Health and Environment Alliance', 'International Red Cross Red Crescent Centre',
                    'University Paul Sabatier Toulouse', 'Goeteborgs University',
                    'Ilmatieteen Laitos', 'Lunds University'
                ],
                'City': [
                    // CHAMNHA
                    'Nairobi', 'Ouagadougou', 'London', 'Seattle', 
                    'Oslo', 'Stockholm', 'Cape Town',
                    
                    // HE2AT
                    'Harare', 'Cape Town', 'Korhogo',
                    'Nairobi', 'Ann Arbor', 'Seattle',
                    
                    // HIGH
                    'Nairobi', 'Geneva',
                    'London', 'Lund',
                    'Stockholm', 'Rome',
                    'Copenhagen', 'Graz',
                    
                    // ENBEL
                    'Nairobi', 'Gaborone',
                    'London', 'Umea',
                    'Graz', 'Rome',
                    'Tartu', 'Oslo',
                    'Oslo', 'Dublin',
                    'Brussels', 'The Hague',
                    'Toulouse', 'Gothenburg',
                    'Helsinki', 'Lund'
                ],
                'Projects': [
                    // CHAMNHA (7)
                    ['CHAMNHA'], ['CHAMNHA'], ['CHAMNHA'], ['CHAMNHA'],
                    ['CHAMNHA'], ['CHAMNHA'], ['CHAMNHA'],
                    
                    // HE2AT (6)
                    ['HE2AT'], ['HE2AT'], ['HE2AT'],
                    ['HE2AT'], ['HE2AT'], ['HE2AT'],
                    
                    // HIGH (8)
                    ['HIGH'], ['HIGH'],
                    ['HIGH'], ['HIGH'],
                    ['HIGH'], ['HIGH'],
                    ['HIGH'], ['HIGH'],
                    
                    // ENBEL (16)
                    ['ENBEL'], ['ENBEL'],
                    ['ENBEL'], ['ENBEL'],
                    ['ENBEL'], ['ENBEL'],
                    ['ENBEL'], ['ENBEL'],
                    ['ENBEL'], ['ENBEL'],
                    ['ENBEL'], ['ENBEL'],
                    ['ENBEL'], ['ENBEL'],
                    ['ENBEL'], ['ENBEL'],
                    ['ENBEL'], ['ENBEL'],
                    ['ENBEL'], ['ENBEL'],
                    ['ENBEL'], ['ENBEL']
                ]
            },
            funders: {
                'Institution': [
                    'UK Research and Innovation', 'Clinical Research Network Norway',
                    'Forte', 'National Institutes of Health',
                    'European Union Horizon Programme'
                ],
                'City': [
                    'London', 'Oslo', 'Stockholm', 'Bethesda', 'Brussels'
                ],
                'Projects': [
                    ['CHAMNHA'], ['CHAMNHA'], ['CHAMNHA'], ['CHAMNHA', 'HE2AT'],
                    ['HIGH', 'ENBEL']
                ]
            }
        };

        // Coordinates lookup
        const coordinates = {
            'Nairobi': [-1.2921, 36.8219],
            'Ouagadougou': [12.3714, -1.5197],
            'London': [51.5074, -0.1278],
            'Seattle': [47.6062, -122.3321],
            'Oslo': [59.9139, 10.7522],
            'Stockholm': [59.3293, 18.0686],
            'Cape Town': [-33.9249, 18.4241],
            'Harare': [-17.8252, 31.0335],
            'Korhogo': [9.4557, -5.6290],
            'Ann Arbor': [42.2808, -83.7430],
            'Geneva': [46.2044, 6.1432],
            'Lund': [55.7047, 13.1910],
            'Rome': [41.9028, 12.4964],
            'Copenhagen': [55.6761, 12.5683],
            'Graz': [47.0707, 15.4395],
            'Gaborone': [-24.6282, 25.9231],
            'Umea': [63.8258, 20.2630],
            'Tartu': [58.3780, 26.7290],
            'Dublin': [53.3498, -6.2603],
            'Brussels': [50.8503, 4.3517],
            'The Hague': [52.0705, 4.3007],
            'Toulouse': [43.6047, 1.4442],
            'Gothenburg': [57.7089, 11.9746],
            'Helsinki': [60.1699, 24.9384],
            'Bethesda': [38.9847, -77.0947]
        };

        // Project colors
        const colors = {
            'CHAMNHA': '#1f77b4',  // Blue
            'HE2AT': '#2ca02c',    // Green
            'HIGH': '#ff7f0e',     // Orange
            'ENBEL': '#d62728',    // Red
            'Funder': '#9467bd'    // Purple
        };

        // Region configurations
        const regions = {
            global: {
                center: { lon: 10, lat: 25 },
                zoom: 1.7,
                lats: [-60, 75],
                lons: [-170, 180]
            },
            africa: {
                center: { lon: 20, lat: 0 },
                zoom: 2.5,
                lats: [-40, 40],
                lons: [-20, 60]
            },
            europe: {
                center: { lon: 10, lat: 50 },
                zoom: 3.8,
                lats: [35, 65],
                lons: [-15, 35]
            },
            usa: {
                center: { lon: -98, lat: 40 },
                zoom: 3.5,
                lats: [25, 50],
                lons: [-125, -65]
            }
        };

        // Initialize active region
        let activeRegion = 'global';
        let showLabels = false;

        // Add click handler for the map
        document.getElementById('map').addEventListener('click', function() {
            if (activeRegion !== 'global') {
                showLabels = !showLabels;
                updateMap();
            }
        });

        function getSelectedFilters() {
            return {
                layers: Array.from(document.querySelectorAll('.layer-filter:checked')).map(cb => cb.value),
                projects: Array.from(document.querySelectorAll('.project-filter:checked')).map(cb => cb.value)
            };
        }

        function createTrace(data, options) {
            const trace = {
                type: 'scattergeo',
                lon: data.lons,
                lat: data.lats,
                text: data.texts,
                name: options.name,
                marker: {
                    size: activeRegion === 'global' ? options.size : options.size + 2,
                    symbol: options.symbol,
                    color: options.color,
                    line: {
                        width: 1,
                        color: 'white'
                    }
                },
                mode: activeRegion === 'global' ? 'markers' : (showLabels ? 'markers+text' : 'markers'),
                textposition: 'top center',
                hoverinfo: 'text',
                showlegend: true,
                legendgroup: options.name,
                textfont: {
                    family: 'Arial, sans-serif',
                    size: 10,
                    color: options.color
                }
            };

            // Add labels if showing and not in global view
            if (showLabels && activeRegion !== 'global') {
                trace.text = data.labels || data.texts;
                // Ensure no text appears in legend when labels are shown
                trace.showlegend = true;
                trace.legendgroup = options.name;
                trace.name = options.name;
            }

            return trace;
        }

        function filterData(data, filters) {
            const filtered = {
                partners: {
                    Institution: [],
                    City: [],
                    Projects: []
                },
                funders: {
                    Institution: [],
                    City: [],
                    Projects: []
                }
            };

            if (filters.layers.includes('partners')) {
                data.partners.Institution.forEach((inst, idx) => {
                    const projects = data.partners.Projects[idx];
                    if (projects.some(p => filters.projects.includes(p))) {
                        filtered.partners.Institution.push(inst);
                        filtered.partners.City.push(data.partners.City[idx]);
                        filtered.partners.Projects.push(projects);
                    }
                });
            }

            if (filters.layers.includes('funders')) {
                data.funders.Institution.forEach((inst, idx) => {
                    const projects = data.funders.Projects[idx];
                    if (projects.some(p => filters.projects.includes(p))) {
                        filtered.funders.Institution.push(inst);
                        filtered.funders.City.push(data.funders.City[idx]);
                        filtered.funders.Projects.push(projects);
                    }
                });
            }

            return filtered;
        }

        function filterDataByRegion(data, region) {
            if (region === 'global') return data;

            const view = regions[region];
            const filtered = {
                partners: {
                    Institution: [],
                    City: [],
                    Projects: []
                },
                funders: {
                    Institution: [],
                    City: [],
                    Projects: []
                }
            };

            // Helper function to check if coordinates are in region bounds
            const isInRegion = (city) => {
                const coords = coordinates[city];
                return coords[0] >= view.lats[0] && coords[0] <= view.lats[1] &&
                       coords[1] >= view.lons[0] && coords[1] <= view.lons[1];
            };

            // Filter partners
            data.partners.Institution.forEach((inst, idx) => {
                if (isInRegion(data.partners.City[idx])) {
                    filtered.partners.Institution.push(inst);
                    filtered.partners.City.push(data.partners.City[idx]);
                    filtered.partners.Projects.push(data.partners.Projects[idx]);
                }
            });

            // Filter funders
            data.funders.Institution.forEach((inst, idx) => {
                if (isInRegion(data.funders.City[idx])) {
                    filtered.funders.Institution.push(inst);
                    filtered.funders.City.push(data.funders.City[idx]);
                    filtered.funders.Projects.push(data.funders.Projects[idx]);
                }
            });

            return filtered;
        }

        function updateMap() {
            const filters = getSelectedFilters();
            const filteredData = filterData(data, filters);
            const view = regions[activeRegion];
            
            const regionFilteredData = filterDataByRegion(filteredData, activeRegion);
            const traces = [];

            // Partner traces
            if (filters.layers.includes('partners')) {
                const projectGroups = {};
                
                Object.keys(regionFilteredData.partners.Projects).forEach((idx) => {
                    const project = regionFilteredData.partners.Projects[idx][0];
                    if (!projectGroups[project]) {
                        projectGroups[project] = {
                            lons: [],
                            lats: [],
                            texts: [],
                            labels: []
                        };
                    }
                    projectGroups[project].lons.push(coordinates[regionFilteredData.partners.City[idx]][1]);
                    projectGroups[project].lats.push(coordinates[regionFilteredData.partners.City[idx]][0]);
                    
                    const institution = regionFilteredData.partners.Institution[idx];
                    const city = regionFilteredData.partners.City[idx];
                    
                    projectGroups[project].texts.push(
                        `<b>${institution}</b><br>` +
                        `${city}<br>` +
                        `Project: ${project}`
                    );
                    projectGroups[project].labels.push(institution);
                });

                Object.entries(projectGroups).forEach(([project, group]) => {
                    traces.push(createTrace(group, {
                        name: project,
                        size: 6,
                        symbol: 'circle',
                        color: 'rgba(44, 62, 80, 0.8)'
                    }));
                });
            }

            // Funder traces
            if (filters.layers.includes('funders')) {
                const funderData = {
                    lons: regionFilteredData.funders.City.map(city => coordinates[city][1]),
                    lats: regionFilteredData.funders.City.map(city => coordinates[city][0]),
                    texts: regionFilteredData.funders.Institution.map((inst, idx) => 
                        `<b>${inst}</b><br>` +
                        `${regionFilteredData.funders.City[idx]}<br>` +
                        `Project: ${regionFilteredData.funders.Projects[idx].join(', ')}`
                    ),
                    labels: regionFilteredData.funders.Institution
                };

                traces.push(createTrace(funderData, {
                    name: 'Funders',
                    size: 7,
                    symbol: 'diamond',
                    color: 'rgba(52, 152, 219, 0.8)'
                }));
            }

            const layout = {
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1,
                    bgcolor: 'rgba(255, 255, 255, 0.9)',
                    bordercolor: '#e0e0e0',
                    borderwidth: 1,
                    font: {
                        family: 'Arial, sans-serif',
                        size: 12,
                        color: '#2c3e50'
                    },
                    itemsizing: 'constant',
                    traceorder: 'normal'
                },
                geo: {
                    scope: activeRegion === 'usa' ? 'usa' : 'world',
                    projection: {
                        type: activeRegion === 'usa' ? 'albers usa' : 'mercator',
                        scale: 1
                    },
                    showland: true,
                    showocean: true,
                    showlakes: false,
                    showcountries: true,
                    showcoastlines: true,
                    coastlinecolor: 'rgb(200, 200, 200)',
                    oceancolor: 'rgb(240, 245, 255)',
                    landcolor: 'rgb(250, 250, 250)',
                    countrycolor: 'rgb(220, 220, 220)',
                    lonaxis: {
                        gridcolor: 'rgb(240, 240, 240)',
                        gridwidth: 0.5,
                        range: view.lons,
                        showgrid: true
                    },
                    lataxis: {
                        gridcolor: 'rgb(240, 240, 240)',
                        gridwidth: 0.5,
                        range: view.lats,
                        showgrid: true
                    },
                    center: view.center,
                    zoom: view.zoom
                },
                margin: {
                    l: 0,
                    r: 0,
                    t: 0,
                    b: 0,
                    pad: 0
                },
                autosize: true,
                hoverlabel: {
                    bgcolor: 'white',
                    font: {
                        family: 'Arial, sans-serif',
                        size: 12,
                        color: '#2c3e50'
                    },
                    bordercolor: '#e0e0e0',
                    align: 'left'
                }
            };

            Plotly.newPlot('map', traces, layout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                displaylogo: false
            }).then(function() {
                // Remove any existing instruction
                const existingInstruction = document.querySelector('.label-instruction');
                if (existingInstruction) {
                    existingInstruction.remove();
                }

                // Add instruction for regional views
                if (activeRegion !== 'global') {
                    const instructionDiv = document.createElement('div');
                    instructionDiv.className = 'label-instruction';
                    
                    const icon = document.createElement('span');
                    icon.className = 'icon';
                    icon.innerHTML = showLabels ? '&#128064;' : '&#128065;';
                    
                    const text = document.createElement('span');
                    text.textContent = showLabels ? 'Hide Labels' : 'Show Labels';
                    
                    instructionDiv.appendChild(icon);
                    instructionDiv.appendChild(text);
                    
                    instructionDiv.onclick = function() {
                        showLabels = !showLabels;
                        updateMap();
                    };
                    
                    document.getElementById('map').appendChild(instructionDiv);
                }
            });

            updateStats(traces);
        }

        function updateStats(traces) {
            const partnerCount = traces.filter(t => t.name.startsWith('Partners')).length;
            const funderCount = traces.filter(t => t.name.startsWith('Funders')).length;
            const countries = new Set(traces.flatMap(t => t.text.map(text => text.split('<br>')[1].split(',')[0].trim()))).size;
            const projects = new Set(traces.flatMap(t => t.text.flatMap(text => text.split('Project: ')[1].split(', ')))).size;

            document.getElementById('partner-count').textContent = partnerCount;
            document.getElementById('funder-count').textContent = funderCount;
            document.getElementById('country-count').textContent = countries;
            document.getElementById('project-count').textContent = projects;
        }

        // Event listeners
        document.querySelectorAll('.layer-filter, .project-filter').forEach(checkbox => {
            checkbox.addEventListener('change', updateMap);
        });

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                activeRegion = e.target.dataset.region;
                updateMap();
            });
        });

        // Initial update
        updateMap();
    </script>
</body>
</html>
